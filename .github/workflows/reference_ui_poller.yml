name: Poll for changes to ReferencedUI

on:
  schedule:
    - cron: '*/5 * * * *'  # Runs every 5 minutes
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  run-command:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Run bash command
        run: |
          # Define the URL
          URL="https://emerynet.api.agoric.net/agoric/vstorage/data/published.vaultFactory.governance"

          # Fetch the new value
          NEW_REFERENCED_UI=$(curl -s $URL | jq -r '.value' | jq -r '.values[]' | jq -r .body | sed 's/^#//' | jq -r .current.ReferencedUI.value)

          # Path to store the previous value
          OLD_NEW_REFERENCED_UI_FILE="./DEPLOYED_HASH"

          # Check if the previous value exists
          if [ -f "$OLD_NEW_REFERENCED_UI_FILE" ]; then
            # Read the previous value
            OLD_REFERENCED_UI=$(cat $previous_value_file)
          else
            # File does not exist, set previous value to empty
            OLD_REFERENCED_UI=""
          fi

          # Compare the new value with the previous value
          if [ "$NEW_REFERENCED_UI" != "$OLD_NEW_REFERENCED_UI_FILE" ]; then
            echo "Value has changed: $NEW_REFERENCED_UI"

            # Save the new value as the previous value
            # echo "$new_value" > $previous_value_file
          else
            echo "Value has not changed."
          fi
